generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id           String                @id @default(uuid())
  name         String
  slug         String                @unique
  logo         String?
  billingEmail String
  status       OrgStatus             @default(ACTIVE)
  plan         BillingPlan           @default(FREE)
  maxUsers     Int                   @default(5)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  customers    Customer[]
  expenses     Expense[]
  invitations  Invitation[]
  invoices     Invoice[]
  settings     OrganizationSettings?
  users        User[]

  @@index([slug])
  @@index([status])
}

model OrganizationSettings {
  id              String       @id @default(uuid())
  organizationId  String       @unique
  primaryColor    String?      @default("#3B82F6")
  logoUrl         String?
  allowSignup     Boolean      @default(true)
  requireApproval Boolean      @default(false)
  invoicePrefix   String       @default("INV")
  taxRate         Float        @default(0)
  currency        String       @default("USD")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model User {
  id                    String                 @id @default(uuid())
  clerkId               String                 @unique
  email                 String                 @unique
  name                  String?
  role                  Role                   @default(USER)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  organizationId        String?
  invitationId          String?                @unique
  isActive              Boolean                @default(true)
  lastLoginAt           DateTime?
  hasCompletedWelcome   Boolean                @default(false)
  accountantAssignments AccountantAssignment[]
  budgets               Budget[]
  company               Company?
  customers             Customer[]
  expenses              Expense[]
  expenseCategories     ExpenseCategory[]
  invoices              Invoice[]
  notes                 Note[]
  organization          Organization?          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([clerkId])
  @@index([email])
  @@index([role])
  @@index([organizationId])
  @@index([organizationId, role])
  @@index([isActive])
}

model Company {
  id        String   @id @default(uuid())
  userId    String   @unique
  name      String
  email     String
  phone     String?
  address   String?
  logo      String?
  taxRate   Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Customer {
  id                    String                 @id @default(uuid())
  userId                String
  name                  String
  email                 String
  phone                 String?
  address               String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  organizationId        String?
  accountantAssignments AccountantAssignment[]
  organization          Organization?          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  expenses              Expense[]
  invoices              Invoice[]

  @@index([userId])
  @@index([organizationId])
}

model Invoice {
  id             String        @id @default(uuid())
  userId         String
  invoiceNumber  String        @unique
  customerId     String
  date           DateTime      @default(now())
  dueDate        DateTime
  status         String        @default("draft")
  subtotal       Float         @default(0)
  tax            Float         @default(0)
  total          Float         @default(0)
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String?
  expenses       Expense[]
  customer       Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  items          InvoiceItem[]

  @@index([userId])
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@index([date])
  @@index([createdAt])
}

model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String
  description String
  quantity    Float
  unitPrice   Float
  total       Float
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model ExpenseCategory {
  id        String    @id @default(uuid())
  userId    String?
  name      String
  isCustom  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  budgets   Budget[]
  expenses  Expense[]
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
}

model Expense {
  id               String          @id @default(uuid())
  userId           String
  date             DateTime        @default(now())
  categoryId       String
  amount           Float
  description      String
  notes            String?
  paymentMethod    String?
  receiptReference String?
  vendorName       String?
  status           String          @default("pending")
  customerId       String?
  invoiceId        String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  organizationId   String?
  category         ExpenseCategory @relation(fields: [categoryId], references: [id])
  customer         Customer?       @relation(fields: [customerId], references: [id])
  invoice          Invoice?        @relation(fields: [invoiceId], references: [id])
  organization     Organization?   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([categoryId])
  @@index([customerId])
  @@index([date])
  @@index([status])
}

model Budget {
  id         String          @id @default(uuid())
  userId     String
  categoryId String
  limit      Float
  period     String          @default("monthly")
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  category   ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
  @@index([categoryId])
}

model AccountantAssignment {
  id           String   @id @default(uuid())
  accountantId String
  customerId   String
  assignedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  accountant   User     @relation(fields: [accountantId], references: [id], onDelete: Cascade)
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([accountantId, customerId])
  @@index([accountantId])
  @@index([customerId])
}

model Note {
  id         String         @id @default(uuid())
  userId     String
  entityType NoteEntityType
  entityId   String
  content    String
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
}

model Invitation {
  id             String           @id @default(uuid())
  email          String
  role           Role
  organizationId String
  invitedBy      String
  invitedAt      DateTime         @default(now())
  expiresAt      DateTime
  status         InvitationStatus @default(PENDING)
  token          String           @unique
  customerIds    String[]
  acceptedAt     DateTime?
  acceptedBy     String?
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([email, organizationId])
  @@index([token])
  @@index([status, expiresAt])
  @@index([organizationId, status])
}

enum Role {
  ADMIN
  USER
  ACCOUNTANT
}

enum OrgStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  CANCELLED
}

enum BillingPlan {
  FREE
  PRO
  ENTERPRISE
}

enum NoteEntityType {
  INVOICE
  EXPENSE
  CUSTOMER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}
